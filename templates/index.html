<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Context Search Engine</title>
    <link href='https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap' rel='stylesheet'>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/icon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="background-pattern"></div>
    
    <div class="container">
        <header class="header">
            <h1 class="title">
                <svg class="title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                Context Search Engine
            </h1>
            <p class="subtitle">AI-powered semantic document search</p>
        </header>

        <div class="main-content">
            {% if has_documents %}
            <div class="search-section active">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Start typing to search..." autocomplete="off">
                    <button id="searchBtn" class="search-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </button>
                </div>
                
                <button id="addMoreBtn" class="add-more-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 4v16m8-8H4"/>
                    </svg>
                    Add More Documents
                </button>

                <div id="searchResults" class="results-container"></div>
                
                <div class="stats">
                    <div class="stat-item" id="documentsStats" onclick="showDocumentsModal()">
                        <span class="stat-value">{{ metadata.documents|length }}</span>
                        <span class="stat-label">Documents</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">{{ metadata.total_chunks }}</span>
                        <span class="stat-label">Indexed Chunks</span>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="upload-section active">
                <div class="upload-prompt">
                    <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M7 18a4.6 4.4 0 0 1 0 -9a5 4.5 0 0 1 11 2h1a3.5 3.5 0 0 1 0 7h-1"/>
                        <polyline points="9 15 12 12 15 15"/>
                        <line x1="12" y1="12" x2="12" y2="21"/>
                    </svg>
                    <h2>Upload Your Documents</h2>
                    <p>Get started by uploading PDF, Word, or text files</p>
                </div>
                
                <div class="upload-box" id="uploadBox">
                    <input type="file" id="fileInput" multiple accept=".pdf,.docx,.txt" hidden>
                    <div class="upload-content">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M7 18a4.6 4.4 0 0 1 0 -9a5 4.5 0 0 1 11 2h1a3.5 3.5 0 0 1 0 7h-1"/>
                            <polyline points="9 15 12 12 15 15"/>
                            <line x1="12" y1="12" x2="12" y2="21"/>
                        </svg>
                        <p class="upload-text">Drag & drop files here or click to browse</p>
                        <p class="upload-subtext">Supports PDF, DOCX, and TXT files (max 16MB each)</p>
                    </div>
                </div>
                
                <div id="fileList" class="file-list"></div>
                <button id="uploadBtn" class="upload-btn" style="display:none;">Upload & Index Documents</button>
            </div>
            {% endif %}
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const hasDocuments = {{ 'true' if has_documents else 'false' }};
        let selectedFiles = [];
        let searchTimeout = null;

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }

        function showModal(title, content) {
            const modal = document.getElementById('modal');
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `<h2>${title}</h2>${content}`;
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        };

        if (hasDocuments) {
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            const resultsDiv = document.getElementById('searchResults');

            async function performSearch() {
                const query = searchInput.value.trim();
                
                if (!query) {
                    resultsDiv.innerHTML = '';
                    return;
                }

                searchBtn.disabled = true;
                searchBtn.innerHTML = '<div class="spinner"></div>';
                
                if (resultsDiv.innerHTML === '') {
                    resultsDiv.innerHTML = '<div class="loading">Searching...</div>';
                }

                try {
                    const response = await fetch('/search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query })
                    });

                    const data = await response.json();

                    if (data.results && data.results.length > 0) {
                        resultsDiv.innerHTML = `
                            <div class="results-header">
                                <h3>Results for: <span class="query-highlight">"${data.query}"</span></h3>
                            </div>
                            ${data.results.map((result, idx) => `
                                <div class="result-card">
                                    <div class="result-header">
                                        <span class="result-number">${idx + 1}</span>
                                        <span class="result-doc">${result.document}</span>
                                        <span class="result-score">Relevance: ${(100 - result.score).toFixed(1)}%</span>
                                    </div>
                                    <p class="result-text">${result.text}</p>
                                </div>
                            `).join('')}
                        `;
                    } else {
                        resultsDiv.innerHTML = '<div class="no-results">No results found. Try a different query.</div>';
                    }
                } catch (error) {
                    resultsDiv.innerHTML = '<div class="error">Error performing search. Please try again.</div>';
                    showToast('Search failed', 'error');
                } finally {
                    searchBtn.disabled = false;
                    searchBtn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    `;
                }
            }

            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                const query = searchInput.value.trim();
                
                if (query.length >= 3) {
                    searchTimeout = setTimeout(() => {
                        performSearch();
                    }, 500);
                } else if (query.length === 0) {
                    resultsDiv.innerHTML = '';
                }
            });

            searchBtn.addEventListener('click', performSearch);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    clearTimeout(searchTimeout);
                    performSearch();
                }
            });

            document.getElementById('addMoreBtn').addEventListener('click', () => {
                const content = `
                    <div class="upload-box-modal" id="uploadBoxModal">
                        <input type="file" id="fileInputModal" multiple accept=".pdf,.docx,.txt" hidden>
                        <div class="upload-content">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M7 18a4.6 4.4 0 0 1 0 -9a5 4.5 0 0 1 11 2h1a3.5 3.5 0 0 1 0 7h-1"/>
                                <polyline points="9 15 12 12 15 15"/>
                                <line x1="12" y1="12" x2="12" y2="21"/>
                            </svg>
                            <p>Click to select files or drag & drop</p>
                        </div>
                    </div>
                    <div id="fileListModal" class="file-list"></div>
                    <button id="uploadBtnModal" class="upload-btn" style="display:none;">Upload & Index Documents</button>
                `;
                showModal('Add More Documents', content);
                setupUploadModal();
            });
        } else {
            setupUploadInterface();
        }

        window.showDocumentsModal = async function() {
            try {
                const response = await fetch('/documents');
                const data = await response.json();
                
                if (data.documents && data.documents.length > 0) {
                    const tableHtml = `
                        <table class="documents-table">
                            <thead>
                                <tr>
                                    <th>Sr. No</th>
                                    <th>Document Name</th>
                                    <th>Type</th>
                                    <th>Uploaded On</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.documents.map((doc, idx) => {
                                    const uploadDate = new Date(doc.uploaded_on);
                                    const formattedDate = uploadDate.toLocaleDateString() + ' ' + uploadDate.toLocaleTimeString();
                                    return `
                                        <tr>
                                            <td data-label="Sr. No">${idx + 1}</td>
                                            <td data-label="Document Name">${doc.filename}</td>
                                            <td data-label="Type">${doc.type}</td>
                                            <td data-label="Uploaded On">${formattedDate}</td>
                                            <td data-label="Action">
                                                <button class="action-btn view-btn" onclick="viewDocument('${doc.id}')">View</button>
                                                <button class="action-btn delete-btn" onclick="confirmDelete('${doc.id}', '${doc.filename}')">Delete</button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                    showModal('Your Documents', tableHtml);
                } else {
                    showModal('Your Documents', '<p style="text-align: center; color: #666;">No documents found.</p>');
                }
            } catch (error) {
                showToast('Failed to load documents', 'error');
            }
        };

        window.viewDocument = async function(docId) {
            try {
                const response = await fetch(`/documents/${docId}`);
                const data = await response.json();
                
                if (data.content) {
                    const contentHtml = `
                        <div class="doc-content">
                            <h3>${data.filename}</h3>
                            <p>${data.content.substring(0, 2000)}${data.content.length > 2000 ? '...' : ''}</p>
                        </div>
                        <button class="upload-btn" onclick="showDocumentsModal()" style="margin-top: 20px;">Back to Documents</button>
                    `;
                    showModal('Document Content', contentHtml);
                } else {
                    showToast('Failed to load document content', 'error');
                }
            } catch (error) {
                showToast('Failed to load document', 'error');
            }
        };

        window.confirmDelete = function(docId, filename) {
            const confirmHtml = `
                <div class="confirm-dialog">
                    <h3>Confirm Delete</h3>
                    <p>Are you sure you want to delete <strong>"${filename}"</strong>?<br><br>
                    This will remove all data and indexes associated with this document. This action cannot be undone.</p>
                    <div class="confirm-buttons">
                        <button class="confirm-btn cancel" onclick="closeModal()">Cancel</button>
                        <button class="confirm-btn delete" onclick="deleteDocument('${docId}')">Delete</button>
                    </div>
                </div>
            `;
            showModal('', confirmHtml);
        };

        window.deleteDocument = async function(docId) {
            try {
                const response = await fetch(`/documents/${docId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    showToast('Document deleted successfully', 'success');
                    closeModal();
                    
                    if (data.metadata.documents.length === 0) {
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        const docCountEl = document.querySelector('.stat-item .stat-value');
                        if (docCountEl) {
                            docCountEl.textContent = data.metadata.documents.length;
                        }
                        const chunkCountEl = document.querySelectorAll('.stat-item .stat-value')[1];
                        if (chunkCountEl) {
                            chunkCountEl.textContent = data.metadata.total_chunks;
                        }
                    }
                } else {
                    showToast('Failed to delete document', 'error');
                }
            } catch (error) {
                showToast('Failed to delete document', 'error');
            }
        };

        function setupUploadInterface() {
            const uploadBox = document.getElementById('uploadBox');
            const fileInput = document.getElementById('fileInput');
            const fileList = document.getElementById('fileList');
            const uploadBtn = document.getElementById('uploadBtn');

            uploadBox.addEventListener('click', () => fileInput.click());
            uploadBox.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadBox.classList.add('drag-over');
            });
            uploadBox.addEventListener('dragleave', () => {
                uploadBox.classList.remove('drag-over');
            });
            uploadBox.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadBox.classList.remove('drag-over');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
            uploadBtn.addEventListener('click', uploadFiles);

            function handleFiles(files) {
                selectedFiles = Array.from(files);
                displayFiles();
            }

            function displayFiles() {
                if (selectedFiles.length === 0) {
                    fileList.innerHTML = '';
                    uploadBtn.style.display = 'none';
                    return;
                }

                fileList.innerHTML = selectedFiles.map((file, idx) => `
                    <div class="file-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                        <span class="file-name">${file.name}</span>
                        <span class="file-size">${(file.size / 1024).toFixed(1)} KB</span>
                        <button class="file-remove" onclick="removeFile(${idx})">Ã—</button>
                    </div>
                `).join('');
                uploadBtn.style.display = 'block';
            }

            window.removeFile = function(idx) {
                selectedFiles.splice(idx, 1);
                displayFiles();
            };

            async function uploadFiles() {
                if (selectedFiles.length === 0) return;

                const formData = new FormData();
                selectedFiles.forEach(file => formData.append('files', file));

                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<div class="spinner"></div> Uploading & Indexing...';

                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success) {
                        showToast(`Successfully uploaded ${data.uploaded.length} file(s)!`, 'success');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showToast('Upload failed: ' + (data.errors.join(', ') || 'Unknown error'), 'error');
                        uploadBtn.disabled = false;
                        uploadBtn.innerHTML = 'Upload & Index Documents';
                    }
                } catch (error) {
                    showToast('Upload failed. Please try again.', 'error');
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = 'Upload & Index Documents';
                }
            }
        }

        function setupUploadModal() {
            const uploadBox = document.getElementById('uploadBoxModal');
            const fileInput = document.getElementById('fileInputModal');
            const fileList = document.getElementById('fileListModal');
            const uploadBtn = document.getElementById('uploadBtnModal');
            let modalFiles = [];

            uploadBox.addEventListener('click', () => fileInput.click());
            uploadBox.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadBox.classList.add('drag-over');
            });
            uploadBox.addEventListener('dragleave', () => {
                uploadBox.classList.remove('drag-over');
            });
            uploadBox.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadBox.classList.remove('drag-over');
                handleModalFiles(e.dataTransfer.files);
            });
            fileInput.addEventListener('change', (e) => {
                handleModalFiles(e.target.files);
            });
            uploadBtn.addEventListener('click', () => uploadModalFiles(modalFiles));

            function handleModalFiles(files) {
                modalFiles = Array.from(files);
                displayModalFiles();
            }

            function displayModalFiles() {
                if (modalFiles.length === 0) {
                    fileList.innerHTML = '';
                    uploadBtn.style.display = 'none';
                    return;
                }

                fileList.innerHTML = modalFiles.map((file, idx) => `
                    <div class="file-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                        <span class="file-name">${file.name}</span>
                        <span class="file-size">${(file.size / 1024).toFixed(1)} KB</span>
                    </div>
                `).join('');
                uploadBtn.style.display = 'block';
            }

            async function uploadModalFiles(files) {
                if (files.length === 0) return;

                const formData = new FormData();
                files.forEach(file => formData.append('files', file));

                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<div class="spinner"></div> Uploading & Indexing...';

                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success) {
                        showToast(`Successfully uploaded ${data.uploaded.length} file(s)!`, 'success');
                        closeModal();
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showToast('Upload failed: ' + (data.errors.join(', ') || 'Unknown error'), 'error');
                        uploadBtn.disabled = false;
                        uploadBtn.innerHTML = 'Upload & Index Documents';
                    }
                } catch (error) {
                    showToast('Upload failed. Please try again.', 'error');
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = 'Upload & Index Documents';
                }
            }
        }
    </script>
</body>
</html>
