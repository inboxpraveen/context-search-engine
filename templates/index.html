<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Context Search Engine</title>
    <link href='https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap' rel='stylesheet'>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/icon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="background-pattern"></div>
    
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-left">
            <span class="app-version">v{{ version }}</span>
        </div>
        <div class="nav-right">
            <button class="nav-btn" onclick="showUploadModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 4v16m8-8H4"/>
                </svg>
                <span>Upload Documents</span>
            </button>
            <button class="nav-btn" onclick="showConfigModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 1v6m0 6v6M1 12h6m6 0h6"/>
                </svg>
                <span>Configure</span>
            </button>
        </div>
    </nav>

    <div class="container">
        <!-- Main Search Area (Google-style) -->
        <div class="search-main">
            <h1 class="search-logo">Context Search</h1>
            
            {% if not has_documents %}
            <p class="no-docs-message">Please upload some documents to start searching</p>
            {% endif %}
            
            <div class="search-wrapper">
                <div class="search-input-container">
                    <svg class="search-icon-left" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="Search across your documents..." 
                        autocomplete="off"
                        {% if not has_documents %}disabled{% endif %}
                    >
                    <button id="clearBtn" class="clear-btn" style="display:none;" onclick="clearSearch()">×</button>
                </div>
                
                {% if has_documents %}
                <div class="search-controls">
                    <div class="search-info">
                        <span id="resultCount"></span>
                    </div>
                    <div class="sort-controls">
                        <label>Sort by:</label>
                        <select id="sortBy" onchange="updateSearch()">
                            <option value="relevance">Relevance</option>
                            <option value="recent">Recent First</option>
                        </select>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Search Results -->
            <div id="searchResults" class="search-results"></div>
            
            <!-- Stats (if no search active) -->
            {% if has_documents %}
            <div id="statsSection" class="stats-section">
                <div class="stat-card" onclick="showDocumentsModal()">
                    <div class="stat-value">{{ metadata.documents|length }}</div>
                    <div class="stat-label">Documents</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ metadata.total_chunks }}</div>
                    <div class="stat-label">Indexed Chunks</div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Modal Container -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const hasDocuments = {{ 'true' if has_documents else 'false' }};
        let searchTimeout = null;
        let currentConfig = {{ config|tojson }};

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.className = 'toast', 3000);
        }

        function showModal(title, content) {
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = title ? `<h2>${title}</h2>${content}` : content;
            document.getElementById('modal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        window.onclick = (e) => {
            if (e.target === document.getElementById('modal')) closeModal();
        };

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('clearBtn').style.display = 'none';
            document.getElementById('resultCount').textContent = '';
            if (document.getElementById('statsSection')) {
                document.getElementById('statsSection').style.display = 'flex';
            }
        }

        if (hasDocuments) {
            const searchInput = document.getElementById('searchInput');
            const clearBtn = document.getElementById('clearBtn');
            const resultsDiv = document.getElementById('searchResults');
            const statsSection = document.getElementById('statsSection');

            searchInput.addEventListener('input', () => {
                const query = searchInput.value.trim();
                clearBtn.style.display = query ? 'block' : 'none';
                
                clearTimeout(searchTimeout);
                if (query.length >= 3) {
                    searchTimeout = setTimeout(() => performSearch(), 500);
                } else if (query.length === 0) {
                    resultsDiv.innerHTML = '';
                    statsSection.style.display = 'flex';
                    document.getElementById('resultCount').textContent = '';
                }
            });

            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    clearTimeout(searchTimeout);
                    performSearch();
                }
            });
        }

        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            const sortBy = document.getElementById('sortBy').value;
            const resultsDiv = document.getElementById('searchResults');
            const statsSection = document.getElementById('statsSection');

            if (!query) return;

            statsSection.style.display = 'none';
            resultsDiv.innerHTML = '<div class="loading-results"><div class="spinner-large"></div><p>Searching...</p></div>';

            try {
                const response = await fetch('/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, sort_by: sortBy })
                });

                const data = await response.json();

                if (data.results && data.results.length > 0) {
                    document.getElementById('resultCount').textContent = 
                        `Found ${data.results.length} result${data.results.length > 1 ? 's' : ''}`;
                    
                    resultsDiv.innerHTML = data.results.map((result, idx) => `
                        <div class="result-item">
                            <div class="result-header">
                                <div class="result-meta">
                                    <span class="result-rank">#${idx + 1}</span>
                                    <span class="result-doc-name">${result.document}</span>
                                    <span class="result-page">Page ${result.page_number}</span>
                                    <span class="result-chunk">Chunk ${result.chunk_number}</span>
                                </div>
                                <button class="view-source-btn" onclick="viewSourceDocument('${result.doc_id}')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14 2 14 8 20 8"/>
                                    </svg>
                                    View Source
                                </button>
                            </div>
                            <div class="result-content">
                                <p>${result.text}</p>
                            </div>
                            <div class="result-footer">
                                <span class="relevance-score">Relevance: ${(100 - Math.min(result.score, 100)).toFixed(1)}%</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    resultsDiv.innerHTML = '<div class="no-results-state"><p>No results found. Try different keywords.</p></div>';
                    document.getElementById('resultCount').textContent = '0 results';
                }
            } catch (error) {
                resultsDiv.innerHTML = '<div class="error-state"><p>Error performing search. Please try again.</p></div>';
                showToast('Search failed', 'error');
            }
        }

        function updateSearch() {
            if (document.getElementById('searchInput').value.trim()) {
                performSearch();
            }
        }

        window.showUploadModal = function() {
            const content = `
                <h3>Upload Documents</h3>
                <div class="upload-section-modal">
                    <div class="upload-box" id="uploadBoxModal">
                        <input type="file" id="fileInputModal" multiple accept=".pdf,.docx,.txt" hidden>
                        <div class="upload-content">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M7 18a4.6 4.4 0 0 1 0 -9a5 4.5 0 0 1 11 2h1a3.5 3.5 0 0 1 0 7h-1"/>
                                <polyline points="9 15 12 12 15 15"/>
                                <line x1="12" y1="12" x2="12" y2="21"/>
                            </svg>
                            <p>Drag & drop files or click to browse</p>
                            <span>Supports PDF, DOCX, TXT (max 16MB each)</span>
                        </div>
                    </div>
                    <div id="fileListModal" class="file-list"></div>
                    <button id="uploadBtnModal" class="primary-btn" style="display:none;">Upload & Index</button>
                </div>
            `;
            showModal('', content);
            setupUploadModal();
        };

        window.showConfigModal = function() {
            const content = `
                <h3>Configuration Settings</h3>
                <div class="config-form">
                    <div class="form-group">
                        <label>HuggingFace Model Repository ID</label>
                        <input type="text" id="modelRepoId" value="${currentConfig.model_repo_id}" 
                               placeholder="e.g., distilbert-base-uncased">
                        <small>Must be compatible with sentence-transformers</small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Chunk Window Size</label>
                            <input type="number" id="chunkSize" value="${currentConfig.chunk_size}" min="100" max="2000">
                        </div>
                        <div class="form-group">
                            <label>Chunk Overlap</label>
                            <input type="number" id="chunkOverlap" value="${currentConfig.chunk_overlap}" min="0" max="500">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Number of Search Results</label>
                            <input type="number" id="numResults" value="${currentConfig.num_search_results}" min="1" max="20">
                        </div>
                        <div class="form-group">
                            <label>Top K (Search Pool)</label>
                            <input type="number" id="topK" value="${currentConfig.top_k}" min="5" max="50">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Embedding Dimension</label>
                        <input type="number" id="dimension" value="${currentConfig.dimension}" min="128" max="1536">
                        <small>Must match your chosen model's output dimension</small>
                    </div>
                    
                    <div class="button-group">
                        <button class="secondary-btn" onclick="closeModal()">Cancel</button>
                        <button class="primary-btn" onclick="saveConfiguration()">Save Configuration</button>
                    </div>
                </div>
            `;
            showModal('', content);
        };

        window.saveConfiguration = async function() {
            const newConfig = {
                model_repo_id: document.getElementById('modelRepoId').value,
                chunk_size: parseInt(document.getElementById('chunkSize').value),
                chunk_overlap: parseInt(document.getElementById('chunkOverlap').value),
                num_search_results: parseInt(document.getElementById('numResults').value),
                top_k: parseInt(document.getElementById('topK').value),
                dimension: parseInt(document.getElementById('dimension').value)
            };

            try {
                const response = await fetch('/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newConfig)
                });

                const data = await response.json();
                
                if (data.success) {
                    currentConfig = data.config;
                    
                    if (data.needs_rebuild && hasDocuments) {
                        showRebuildConfirmation();
                    } else {
                        showToast('Configuration saved successfully', 'success');
                        closeModal();
                    }
                } else {
                    showToast('Failed to save configuration', 'error');
                }
            } catch (error) {
                showToast('Error saving configuration', 'error');
            }
        };

        function showRebuildConfirmation() {
            const content = `
                <div class="confirm-dialog">
                    <h3>Rebuild Index Required</h3>
                    <p>You've changed the model or chunking settings. To apply these changes, the index needs to be rebuilt.</p>
                    <p><strong>This may take a few minutes depending on your document count.</strong></p>
                    <div class="button-group">
                        <button class="secondary-btn" onclick="closeModal()">Later</button>
                        <button class="primary-btn" onclick="rebuildIndex()">Rebuild Now</button>
                    </div>
                </div>
            `;
            showModal('', content);
        }

        async function rebuildIndex() {
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="loading-state">
                    <div class="spinner-large"></div>
                    <h3>Rebuilding Index</h3>
                    <p>Please wait while we reindex your documents...</p>
                </div>
            `;

            try {
                const response = await fetch('/rebuild-index', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    showToast('Index rebuilt successfully!', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast('Failed to rebuild index', 'error');
                    closeModal();
                }
            } catch (error) {
                showToast('Error rebuilding index', 'error');
                closeModal();
            }
        }

        window.showDocumentsModal = async function() {
            try {
                const response = await fetch('/documents');
                const data = await response.json();
                
                if (data.documents && data.documents.length > 0) {
                    const content = `
                        <h3>Your Documents</h3>
                        <div class="documents-table-container">
                            <table class="documents-table">
                                <thead>
                                    <tr>
                                        <th>Sr. No</th>
                                        <th>Document Name</th>
                                        <th>Type</th>
                                        <th>Pages</th>
                                        <th>Uploaded On</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.documents.map((doc, idx) => {
                                        const uploadDate = new Date(doc.uploaded_on);
                                        const formattedDate = uploadDate.toLocaleDateString() + ' ' + 
                                                            uploadDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                                        return `
                                            <tr>
                                                <td data-label="Sr. No">${idx + 1}</td>
                                                <td data-label="Document Name">${doc.filename}</td>
                                                <td data-label="Type">${doc.type}</td>
                                                <td data-label="Pages">${doc.pages || 1}</td>
                                                <td data-label="Uploaded On">${formattedDate}</td>
                                                <td data-label="Action">
                                                    <button class="action-btn view-btn" onclick="viewDocument('${doc.id}')">View</button>
                                                    <button class="action-btn delete-btn" onclick="confirmDelete('${doc.id}', '${doc.filename}')">Delete</button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    showModal('', content);
                } else {
                    showModal('Your Documents', '<p class="empty-state">No documents found.</p>');
                }
            } catch (error) {
                showToast('Failed to load documents', 'error');
            }
        };

        window.viewDocument = async function(docId) {
            try {
                const response = await fetch(`/documents/${docId}`);
                const data = await response.json();
                
                if (data.content) {
                    const content = `
                        <h3>${data.filename}</h3>
                        <div class="document-viewer">
                            <div class="doc-info">
                                <span>Type: ${data.type}</span>
                                <span>Pages: ${data.pages || 1}</span>
                            </div>
                            <div class="doc-content">
                                <p>${data.content.substring(0, 3000)}${data.content.length > 3000 ? '...' : ''}</p>
                            </div>
                        </div>
                        <button class="secondary-btn" onclick="showDocumentsModal()">Back to Documents</button>
                    `;
                    showModal('', content);
                } else {
                    showToast('Failed to load document', 'error');
                }
            } catch (error) {
                showToast('Failed to load document', 'error');
            }
        };

        window.viewSourceDocument = async function(docId) {
            viewDocument(docId);
        };

        window.confirmDelete = function(docId, filename) {
            const content = `
                <div class="confirm-dialog">
                    <h3>Confirm Delete</h3>
                    <p>Are you sure you want to delete <strong>"${filename}"</strong>?</p>
                    <p>This will remove all data and indexes. This action cannot be undone.</p>
                    <div class="button-group">
                        <button class="secondary-btn" onclick="closeModal()">Cancel</button>
                        <button class="delete-btn-primary" onclick="deleteDocument('${docId}')">Delete</button>
                    </div>
                </div>
            `;
            showModal('', content);
        };

        window.deleteDocument = async function(docId) {
            try {
                const response = await fetch(`/documents/${docId}`, { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    showToast('Document deleted successfully', 'success');
                    if (data.metadata.documents.length === 0) {
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        closeModal();
                        setTimeout(() => location.reload(), 1000);
                    }
                } else {
                    showToast('Failed to delete document', 'error');
                }
            } catch (error) {
                showToast('Failed to delete document', 'error');
            }
        };

        function setupUploadModal() {
            const uploadBox = document.getElementById('uploadBoxModal');
            const fileInput = document.getElementById('fileInputModal');
            const fileList = document.getElementById('fileListModal');
            const uploadBtn = document.getElementById('uploadBtnModal');
            let modalFiles = [];

            uploadBox.addEventListener('click', () => fileInput.click());
            uploadBox.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadBox.classList.add('drag-over');
            });
            uploadBox.addEventListener('dragleave', () => uploadBox.classList.remove('drag-over'));
            uploadBox.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadBox.classList.remove('drag-over');
                handleFiles(e.dataTransfer.files);
            });
            fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
            uploadBtn.addEventListener('click', () => uploadFiles());

            function handleFiles(files) {
                modalFiles = Array.from(files);
                displayFiles();
            }

            function displayFiles() {
                if (modalFiles.length === 0) {
                    fileList.innerHTML = '';
                    uploadBtn.style.display = 'none';
                    return;
                }

                fileList.innerHTML = modalFiles.map((file, idx) => `
                    <div class="file-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                        <span class="file-name">${file.name}</span>
                        <span class="file-size">${(file.size / 1024).toFixed(1)} KB</span>
                        <button class="file-remove" onclick="event.stopPropagation(); removeModalFile(${idx})">×</button>
                    </div>
                `).join('');
                uploadBtn.style.display = 'block';
            }

            window.removeModalFile = function(idx) {
                modalFiles.splice(idx, 1);
                displayFiles();
            };

            async function uploadFiles() {
                if (modalFiles.length === 0) return;

                const formData = new FormData();
                modalFiles.forEach(file => formData.append('files', file));

                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<div class="spinner"></div> Uploading...';

                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success) {
                        showToast(`Uploaded ${data.uploaded.length} file(s) successfully!`, 'success');
                        closeModal();
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showToast('Upload failed: ' + (data.errors.join(', ')), 'error');
                        uploadBtn.disabled = false;
                        uploadBtn.innerHTML = 'Upload & Index';
                    }
                } catch (error) {
                    showToast('Upload failed. Please try again.', 'error');
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = 'Upload & Index';
                }
            }
        }
    </script>
</body>
</html>
